<template>
  <div>
    <el-card style="margin:10px">
      <el-form :inline="false" :model="table.queryParams" size="small">
        <el-row :gutter="40">
          <el-col :span="8">
            <el-form-item :label="$t('name')">
              <el-input v-model="table.queryParams.name" clearable></el-input>
            </el-form-item>
          </el-col>
          <el-col :span="8" :offset="8" style="text-align:right">
           <el-button type="primary" size="small" @click="requestData" icon="el-icon-search">{{ $t('search') }}</el-button>
          </el-col>
        </el-row>
      </el-form>
    </el-card>
    <el-card style="margin:10px">
      <table-action :title="$t('meta.title.role')">
        <template #action>
          <el-button type="primary" size="small" v-if="addPermission"  @click="showAddRoleDialog" icon="el-icon-plus">{{ $t('add') }}</el-button>
        </template>
      </table-action>
      <el-table
              :data="table.data"
              v-loading="table.loading"
              border
              style="width: 100%">
        <el-table-column
                prop="name"
                :label="$t('name')">
        </el-table-column>
        <el-table-column
                prop="guard_name"
                :label="$t('guardName')">
        </el-table-column>
        <el-table-column
                prop="description"
                :label="$t('description')">
        </el-table-column>
        <el-table-column
                prop="created_at"
                :label="$t('createdAt')">
        </el-table-column>
        <el-table-column
                prop="updated_at"
                :label="$t('updatedAt')">
        </el-table-column>
        <el-table-column
                fixed="right"
                width="220px"
                :label="$t('actions')"
                >
          <template #default="scope">
            <el-button
                    v-if="updatePermission"
                    type="text"
                    size="mini"
                    @click="showEditRoleDialog(scope.row)">{{ $t('edit') }}</el-button>
            <el-button
                    v-if="assignPermission"
                    @click="showAssignPermissionDrawer(scope.row)"
                    type="text"
                    size="mini">{{ $t('assignPermission') }}</el-button>
            <el-button
                    v-if="assignMenu"
                    @click="showAssignMenuDrawer(scope.row)"
                    type="text"
                    size="mini">{{ $t('assignMenu') }}</el-button>

            <el-popconfirm v-if="deletePermission" :title="$t('confirmDelete')" @confirm="handleDelete(scope.$index, scope.row)">
              <template #reference>
                <el-button size="mini" type="text">{{ $t('delete') }}</el-button>
              </template>
            </el-popconfirm>
          </template>
        </el-table-column>
      </el-table>
      <el-pagination class="pagination-right"
                     @current-change="requestData"
                     v-model:currentPage="table.pagination.currentPage"
                     :page-size="table.pagination.pageSize"
                     layout="total, prev, pager, next, jumper"
                     :total="table.pagination.total">
      </el-pagination>
    </el-card>
    <el-dialog :title="dialogAction == 'add' ? $t('add') : $t('edit')" v-model="dialogFormVisible"  width="500px">
      <el-form :model="form" :rules="rules" label-width="120px" size="small" ref="formRef">
        <el-form-item :label="$t('name')" prop="name">
          <el-input v-model="form.name"></el-input>
        </el-form-item>
        <el-form-item :label="$t('guardName')" prop="guard_name">
          <guard-select v-model="form.guard_name"></guard-select>
        </el-form-item>
        <el-form-item :label="$t('description')" prop="description">
          <el-input type="textarea" v-model="form.description"></el-input>
        </el-form-item>
      </el-form>
      <template #footer>
        <el-button size="small" @click="dialogFormVisible = false">{{ $t('cancel') }}</el-button>
        <el-button size="small" type="primary" @click="handleAddRole" v-if="dialogAction == 'add'">{{ $t('confirm') }}</el-button>
        <el-button size="small" type="primary" @click="handleEditRole" v-if="dialogAction == 'edit'">{{ $t('confirm') }}</el-button>
      </template>
    </el-dialog>
    <role-assign-permission-drawer v-model="assignPermissionDrawer" :role-id="assignPermissionRole.id" :guard-name="assignPermissionRole.guardName"></role-assign-permission-drawer>
    <role-assign-menu-drawer v-model="assignMenuDrawer" :role-id="assignMenuRole.id" :guard-name="assignMenuRole.guardName"></role-assign-menu-drawer>
  </div>
</template>

<script>
import { getRoleList, addRole, editRole, deleteRole } from '@/api/role'
import GuardSelect from '@/components/Select/GuardSelect.vue'
import TableAction from '@/components/Table/TableAction.vue'
import { tableDataFormat, tableDefaultData } from '@/utils/table'
import { ref, computed } from 'vue'
import { useStore } from 'vuex'
import notice from '@/utils/notice'
import RoleAssignPermissionDrawer from './RoleAssignPermissionDrawer.vue'
import RoleAssignMenuDrawer from './RoleAssignMenuDrawer.vue'

export default {
  name: 'roleIndex',
  components: {
    GuardSelect,
    TableAction,
    RoleAssignPermissionDrawer,
    RoleAssignMenuDrawer
  },
  setup() {
    const table = tableDefaultData()
    const store = useStore()

    const requestData = () => {
      table.loading = true
      getRoleList(table.getQueryParams()).then( response => {
        tableDataFormat(response, table)
      })
    }

    requestData()

    const formRef = ref(null)
    const form = ref({
      name: null,
      guard_name: null,
      description: null,
    })
    const dialogFormVisible = ref(false)

    const dialogAction = ref('add')

    const showAddRoleDialog = () => {
      dialogAction.value = 'add'
      dialogFormVisible.value = true
      form.value = {
        name: null,
        guard_name: null,
        description: null,
      }
    }

    const updateRow = ref({})

    const showEditRoleDialog = (row) => {
      dialogAction.value = 'edit'
      dialogFormVisible.value = true
      form.value = {
        name: row.name,
        guard_name: row.guard_name,
        description: row.description,
      }
      updateRow.value = row
    }

    const handleAddRole = () => {
      formRef.value.validate((valid) => {
        if (!valid) {
          return false
        }
        addRole(form.value).then(() => {
          notice.addSuccess()
          dialogFormVisible.value = false
        })
      })
    }

    const handleEditRole = () => {
      formRef.value.validate((valid) => {
        if (!valid) {
          return false
        }
        editRole(updateRow.value.id, form.value).then(() => {
          notice.editSuccess()
          updateRow.value.name = form.value.name
          updateRow.value.guard_name = form.value.guard_name
          updateRow.value.description = form.value.description
          dialogFormVisible.value = false
        })
      })
    }

    const handleDelete = (index, row) => {
      deleteRole(row.id).then( () => {
        notice.deleteSuccess()
        table.data.splice(index, 1)
      })
    }

    const assignPermissionDrawer = ref(false)
    const assignPermissionRole = ref({
      id: 0,
      guardName: null,
    })
    const showAssignPermissionDrawer = (row) => {
      assignPermissionDrawer.value = true
      assignPermissionRole.value.id = row.id
      assignPermissionRole.value.guardName = row.guard_name
    }
    const assignMenuDrawer = ref(false)
    const assignMenuRole = ref({
      id: 0,
      guardName: null,
    })
    const showAssignMenuDrawer = (row) => {
      assignMenuDrawer.value = true
      assignMenuRole.value.id = row.id
      assignMenuRole.value.guardName = row.guard_name
    }
    return {
      table,
      requestData,
      formRef,
      form,
      dialogFormVisible,
      dialogAction,
      showAddRoleDialog,
      showEditRoleDialog,
      handleAddRole,
      handleEditRole,
      handleDelete,
      showAssignPermissionDrawer,
      assignPermissionDrawer,
      assignPermissionRole,
      showAssignMenuDrawer,
      assignMenuDrawer,
      assignMenuRole,
      updatePermission: computed(() => store.getters.hasPermission('role.update')),
      addPermission: computed(() => store.getters.hasPermission('role.store')),
      deletePermission: computed(() => store.getters.hasPermission('role.destroy')),
      assignPermission: computed(() => store.getters.hasPermission('role.assign-permissions')),
      assignMenu: computed(() => store.getters.hasPermission('role.assign-menus')),
      rules: {
        name: [
          { required: true },
          { min: 1, max: 255 }
        ],
        guard_name: [
          { required: true },
          { min: 1, max: 255 }
        ]
      },
    }
  },
}
</script>